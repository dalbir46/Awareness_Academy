<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mathematics Hub Class 6 to 12</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: Arial, sans-serif; background: #f0f8ff; margin: 0; padding: 0; color: #000; }

/* Header & Footer */
.header-wrapper { background: #1e293b; color: #fff; padding: 16px; font-size: 21px; font-weight: 700; text-align: center; border-bottom: 2px solid #334155; }
.footer-inner { background: #1e293b; color: #fff; padding: 16px; text-align: center; border-top: 2px solid #334155; }

/* Shoutbox / messages */
#shoutbox { margin: 20px auto; max-width: 700px; border: 2px solid #334155; border-radius: 8px; background: #fff; padding: 12px; }
.msg { border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px; margin-bottom: 6px; background: #f9f9f9; position: relative; }
.msg .serial { font-weight: 700; margin-right: 6px; }
.msg[data-status="Working"] { border-left: 4px solid blue; }
.msg[data-status="Solved"] { border-left: 4px solid green; }

/* Admin Buttons */
.mark-working, .mark-solved { margin: 2px; padding: 6px 8px; cursor: pointer; }
.admin-buttons { display: flex; gap: 4px; flex-wrap: wrap; }

/* Input area */
#inputArea { max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 6px; }
#inputArea input, #inputArea textarea { padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 100%; }
#inputArea button { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; background: #3b82f6; color: #fff; font-weight: 700; }

</style>
</head>
<body>
<div class="header-wrapper">Mathematics Hub - Class 6 to 12</div>

<div id="inputArea">
  <input type="text" id="username" placeholder="Your Name">
  <textarea id="message" placeholder="Enter your doubt..."></textarea>
  <input type="file" id="photoInput">
  <button id="sendBtn">Send</button>
</div>

<div id="messagesWrapper">
  <div id="messages"></div>
</div>

<div id="latestUpdates" style="max-width:700px;margin:10px auto;">
  <p>Total Doubts: <span id="totalDoubts">0</span></p>
  <p>Working: <span id="workingDoubts">0</span></p>
  <p>Solved: <span id="solvedDoubts">0</span></p>
</div>

<div id="adminControls" style="max-width:700px;margin:10px auto; display:flex; gap:6px;">
  <button id="clearBtn">Clear All</button>
  <button id="deleteSelectedBtn">Delete Selected</button>
  <button id="logoutBtn">Logout</button>
</div>
<script>
// ===== Firebase reference assumed =====
const db = firebase.database(); // Make sure Firebase initialized
const ADMIN_PASSWORD = "admin123"; // replace with your real password
let adminAuthenticated = false;

function isAdminAuthenticated() { return adminAuthenticated; }
function setAdminAuthenticated(value) { adminAuthenticated = value; updateAdminUI(); }

function updateAdminUI() {
  const show = isAdminAuthenticated();
  document.getElementById("clearBtn").style.display = show ? "inline-block" : "none";
  document.getElementById("deleteSelectedBtn").style.display = show ? "inline-block" : "none";
  document.getElementById("logoutBtn").style.display = show ? "inline-block" : "none";
}

// ===== Send Message =====
document.getElementById("sendBtn").addEventListener("click", async ()=>{
  const nameEl = document.getElementById("username");
  const msgEl = document.getElementById("message");
  const photoEl = document.getElementById("photoInput");
  const name = (nameEl && nameEl.value) ? nameEl.value.trim() : "";
  const msg = (msgEl && msgEl.value) ? msgEl.value.trim() : "";
  if (!name && !msg && (!photoEl || !photoEl.files[0])) return alert("Enter message or photo.");

  // Admin login shortcut if someone enters name "admin"
  if (name.toLowerCase() === "admin" && !isAdminAuthenticated()){
    const pwd = prompt("Enter admin password:");
    if (pwd === ADMIN_PASSWORD){
      setAdminAuthenticated(true);
    } else {
      alert("Incorrect password.");
      return;
    }
  }

  let photoURL = "";
  if (photoEl && photoEl.files[0]){
    try {
      photoURL = await uploadToImgbb(photoEl.files[0]); // function assumed defined elsewhere
      photoEl.value = "";
    } catch(e){
      alert("Image upload failed: " + e);
      return;
    }
  }

  const data = { name: name || "Guest", message: msg || "", time: Date.now(), photoURL };
  db.ref("shoutbox").push(data);
  if (msgEl) msgEl.value = "";
});
  // ===== Admin Controls =====

// Clear shoutbox (admin only)
document.getElementById("clearBtn").addEventListener("click", ()=>{
  if (isAdminAuthenticated()){
    if (confirm("Clear all messages?")) {
      db.ref("shoutbox").remove();
      const messagesEl = document.getElementById("messages");
      if (messagesEl) messagesEl.innerHTML = "";
      refreshDoubtNumbers();
      updateDoubtStats();
    }
  } else {
    alert("Admin only");
  }
});

// Delete selected (admin)
document.getElementById("deleteSelectedBtn").addEventListener("click", ()=>{
  if (!isAdminAuthenticated()) return alert("Admin only");
  const checked = document.querySelectorAll(".msgCheck:checked");
  if (!checked.length) return alert("Select messages to delete.");
  if (!confirm(`Delete ${checked.length} selected message(s)?`)) return;
  checked.forEach(chk=>{
    const key = chk.getAttribute("data-key");
    if (key) db.ref("shoutbox/"+key).remove();
    const el = document.querySelector(`.msg[data-key='${key}']`);
    if (el) el.remove();
  });
  refreshDoubtNumbers();
  updateDoubtStats();
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  setAdminAuthenticated(false);
  alert("Admin logged out.");
});
  // ===== Initial UI Update =====
refreshDoubtNumbers();
updateDoubtStats();
updateAdminUI();

// ===== Theme Dropdown handling =====
const themeSelect = document.getElementById("themeSelect");
const savedTheme = localStorage.getItem('theme') || 'light';
if (savedTheme === 'dark') {
  document.body.classList.add('dark');
  if (themeSelect) themeSelect.value = 'dark';
} else {
  if (themeSelect) themeSelect.value = 'light';
}

if (themeSelect) {
  themeSelect.addEventListener('change', function() {
    const mode = this.value;
    if (mode === 'dark') document.body.classList.add('dark');
    else document.body.classList.remove('dark');
    localStorage.setItem('theme', mode);
  });
}

// ===== Dark Mode CSS injection =====
const style = document.createElement("style");
style.innerHTML = `
  body.dark { background:#0f1724; color:#d1d5db; }
  body.dark .msg { background:#07203a; color:#d1d5db; border-color:#12324a; }
  body.dark .box, body.dark .box-welcome { background:#1e293b; color:#d1d5db; border-color:#334155; }
  body.dark .header, body.dark .footer-inner {
    background:#1e293b;
    color:#e2e8f0;
    border-color:#334155;
    text-shadow:none;
    font-size:21px;
    font-weight:700;
    padding:16px;
  }
  /* Dark Mode Notice Board */
  body.dark .welcome-cover {
    background: linear-gradient(90deg,#1e1b4b,#3b0764);
    border: 2px solid #8b5cf6;
    border-radius: 8px;
    padding: 6px;
    box-shadow:0 6px 18px rgba(11,6,34,0.6),0 0 12px rgba(139,92,246,0.08) inset;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    position: relative;
    overflow: hidden;
  }
  body.dark .welcome-cover .section-title {
    color: #facc15;
    font-weight:700;
    text-shadow:0 1px 0 rgba(0,0,0,0.6),0 6px 18px rgba(250,204,21,0.06);
  }
  body.dark .welcome-cover .section-title::after {
    content:"";
    display:block;
    margin:8px auto 0;
    width:54px;
    height:3px;
    border-radius:3px;
    background: linear-gradient(90deg,rgba(250,204,21,0.9),rgba(139,92,246,0.8));
    box-shadow:0 6px 18px rgba(139,92,246,0.12);
  }
  body.dark .welcome-cover .section-title u { text-decoration: none; }
  body.dark button, body.dark .btn { filter: brightness(1.2); }
  body.dark #shoutbox { background:#1e293b; color:#d1d5db; border-color:#334155; }
  body.dark input, body.dark textarea { background:#334155; color:#d1d5db; border-color:#1e293b; }
`;
document.head.appendChild(style);
  // === Handle Admin Mark Buttons (delegated) ===
document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("mark-working") || e.target.classList.contains("mark-solved")) {
    if (!isAdminAuthenticated()) return alert("Admin only");

    const key = e.target.getAttribute("data-key");
    const status = e.target.classList.contains("mark-working") ? "Working" : "Solved";

    try {
      await db.ref("shoutbox/" + key).update({ status });

      // update DOM element if exists
      const el = document.querySelector(`.msg[data-key='${key}']`);
      if (el) el.dataset.status = status;

      alert(`Doubt marked as ${status}`);
    } catch(err) {
      alert("Failed to update status: " + err);
    }

    updateDoubtStats();
    refreshDoubtNumbers();
  }
});
  // === Realtime DB listener & apply updates ===
db.ref("shoutbox").on("value", () => {
  const messagesEl = document.getElementById("messages");
  if (!messagesEl) return;

  messagesEl.innerHTML = ""; // clear existing

  const data = [];
  db.ref("shoutbox").once("value").then(snapshot => {
    snapshot.forEach(child => {
      data.push({ key: child.key, ...child.val() });
    });

    // Sort by timestamp ascending (oldest first)
    data.sort((a,b) => a.time - b.time);

    // Add messages to DOM
    data.forEach((item, index) => {
      const msgDiv = document.createElement("div");
      msgDiv.className = "msg";
      msgDiv.dataset.key = item.key;
      msgDiv.dataset.status = item.status || "";

      // Reverse numbering: oldest = 01
      const serial = String(index + 1).padStart(2, '0');

      msgDiv.innerHTML = `
        <span class="serial">${serial}</span>
        <strong>${item.name}</strong>: ${item.message}
        ${item.photoURL ? `<br><img src="${item.photoURL}" style="max-width:200px; display:block; margin-top:4px;">` : ""}
        ${isAdminAuthenticated() ? `
          <div class="admin-buttons">
            <button class="mark-working" data-key="${item.key}">Working</button>
            <button class="mark-solved" data-key="${item.key}">Solved</button>
            <input type="checkbox" class="msgCheck" data-key="${item.key}">
          </div>
        ` : ""}
      `;
      messagesEl.appendChild(msgDiv);
    });

    // ===== Latest Updates colors =====
    const total = data.length;
    const workingCount = data.filter(d=>d.status==="Working").length;
    const solvedCount = data.filter(d=>d.status==="Solved").length;

    const totalEl = document.getElementById("totalDoubts");
    const workingEl = document.getElementById("workingDoubts");
    const solvedEl = document.getElementById("solvedDoubts");

    if(totalEl){ totalEl.textContent = total; totalEl.style.color = "red"; }
    if(workingEl){ workingEl.textContent = workingCount; workingEl.style.color = "blue"; }
    if(solvedEl){ solvedEl.textContent = solvedCount; solvedEl.style.color = "green"; }

  });
});

// === Small / side-by-side buttons CSS injection ===
const btnStyle = document.createElement("style");
btnStyle.innerHTML = `
  .mark-working, .mark-solved {
    font-size: 12px;
    padding: 4px 6px;
    margin: 2px;
    display: inline-block;
  }
  .admin-buttons {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }
`;
document.head.appendChild(btnStyle);
  // ===== Initial stats update on page load =====
refreshDoubtNumbers();
updateDoubtStats();
updateAdminUI();

// Optional: keep stats in sync when overall DB changes
db.ref("shoutbox").on("value", () => {
  refreshDoubtNumbers();
  updateDoubtStats();
});

</script>
</body>
</html>
