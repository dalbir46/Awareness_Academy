<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mathematics Hub Class 6 to 12</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- marked.js for markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- MathJax for LaTeX rendering -->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
/* ---------- ORIGINAL STYLES (kept as-is, small additions at end) ---------- */
body { font-family: Arial, sans-serif; background: #f0f8ff; margin: 0; padding: 0; color: #000; }

/* Header & Footer */
.header-wrapper, .footer-wrapper { background: linear-gradient(135deg, #6a11cb, #2575fc); padding: 12px; }
.header, .footer-inner { background: #FFFFCC; padding: 15px; text-align: center; font-size: 20px; font-weight: bold; border: 2px solid #333; border-radius: 10px; text-shadow: 2px 2px 4px #888888; max-width: 600px; margin: auto; }
.header div { margin: 5px 0; }

/* Section Titles */
.section-title { text-align: center; color: #fff; padding: 10px; font-weight: bold; font-size: 16px; }
.title-class   { background: #2196F3; }
.title-updates { background: #2F4F4F; }
.title-practice{ background: #9C27B0; }
.title-res     { background: #009688; }
.title-shout   { background: #F44336; }
.title-contact { background: #4B0082; }

/* Boxes */
.box { border: 1px solid #999; margin: 5px; padding: 10px; background: #F9F9F9; font-size: 14px; }
.box-welcome { border: 2px solid #9C27B0; margin: 10px; padding: 20px; font-size: 16px; background: #F3E5F5; text-align: center; border-radius: 8px; }

/* Linkbar */
.linkbar { background: linear-gradient(45deg, #FF9800, #E91E63); padding: 8px; text-align: center; }
.linkbar a { color: #fff; text-decoration: none; font-weight: bold; margin: 0 10px; }
.linkbar a:hover { text-decoration: underline; }

/* Small text */
.small { font-size: 12px; color: #555; }
.blue { color: #3366CC; font-weight: bold; }

/* Buttons */
button, .btn { border: none; padding: 12px 14px; color: #fff; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 6px; width: 100%; height: 60px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; }
button:hover, .btn:hover { filter: brightness(0.85); }
.class-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; justify-items: center; }

/* Class Buttons */
.btn6  { background: #FF5722; }
.btn7  { background: #4CAF50; }
.btn8  { background: #9C27B0; }
.btn9  { background: #3F51B5; }
.btn10 { background: #455A64; }
.btn11 { background: #00BFFF; }
.btn12 { background: #DC143C; }

/* MCQ Class 12 Button */
.btn-mcq12 { background-color: #8B0000; }

/* Contact Buttons */
#contact-buttons #whatsapp-btn { background-color: #25D366; color: #fff; }
#contact-buttons #telegram-btn { background-color: #1DA1F2; color: #fff; }

/* Elegant Outer cover for Notice Board */
.welcome-cover { background: #F3E5F5; padding: 6px; border-radius: 8px; margin: 12px; border: 6px solid #9C27B0; }
.welcome-cover .section-title { margin: 0; font-size: 18px; background: transparent; color: black; border-radius: 6px; }
.welcome-cover .section-title u { text-decoration: underline; }

/* Shoutbox */
#shoutbox { background: #fff; border: 2px solid #F44336; border-radius: 6px; padding: 10px; margin: 10px; }
#messages { max-height: 300px; overflow-y: auto; display: flex; flex-direction: column-reverse; margin-bottom: 8px; }
.msg { border-bottom: 1px solid #ddd; padding: 6px; display:flex; gap:10px; align-items:flex-start; }
.msg .bubble { background:#F9F9F9; padding:8px 12px; border-radius:12px; border:1px solid #eee; flex:1; }
.msg .meta { font-size: 12px; color: gray; margin-top:6px; }
#shoutbox input[type=text], #shoutbox input[type=file] { padding: 6px; width: 100%; border: 1px solid #FFA500; border-radius: 4px; margin-bottom: 6px; box-sizing: border-box; }

/* Buttons in shoutbox */
#shoutbox .send-wrapper { display: flex; justify-content: flex-end; margin-top: -2px; gap:8px; flex-wrap:wrap; }

/* Send button */
#shoutbox button#sendBtn { padding: 6px 14px; font-size: 12px; border-radius: 4px; background-color: #4CAF50; color: #fff; cursor: pointer; width: auto; height: auto; }
#shoutbox button#sendBtn:hover { background-color: #45a049; }

/* Admin buttons style same as clear */
#clearBtn, #deleteSelectedBtn, #logoutBtn {
  padding: 6px 14px;
  font-size: 12px;
  border-radius: 4px;
  color: #fff;
  cursor: pointer;
  width: auto;
  height: auto;
}
#clearBtn { background-color: red; }
#clearBtn:hover { background-color: darkred; }
#deleteSelectedBtn { background-color: #8B0000; display:none; }
#deleteSelectedBtn:hover { background-color: #8B0000; filter: brightness(0.85); }
#logoutBtn { background-color: #555; display:none; }
#logoutBtn:hover { background-color: #555; filter: brightness(0.85); }

#adminStatus { color:green; font-weight:bold; margin-bottom:6px; display:none; }

/* Progress bar */
#uploadProgress { width:100%; background:#eee; border-radius:4px; margin:6px 0; display:none; }
#uploadBar { width:0%; height:8px; background:#4CAF50; border-radius:4px; }

@media(max-width:600px){ #shoutbox .send-wrapper { justify-content:flex-start; margin-top:6px; } #shoutbox button{ width:100%; } }

/* ----------------- NEW/ADDED STYLES FOR FEATURES ----------------- */
.username { color: #3366CC; font-weight: bold; margin-right:6px; }
.username.admin { color: #D32F2F; }
.user-bubble { border-radius: 18px; } /* rounded bubbles */
.msg .avatar { width:36px; height:36px; border-radius:50%; background:#ccc; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff; flex-shrink:0; }
.controls { display:flex; gap:6px; align-items:center; margin-left:auto; }
.small-btn { background:none; border:none; cursor:pointer; font-size:14px; padding:4px; border-radius:4px; }
.small-btn:hover { background:#f0f0f0; }
.reactions { display:inline-flex; gap:6px; margin-top:6px; }
.reaction { cursor:pointer; padding:2px 6px; border-radius:12px; border:1px solid #eee; font-size:13px; }
.pinned { border-left:4px solid gold; padding-left:8px; }
.highlight-admin { background: #fffbe6; border:1px solid #ffe58f; }

/* Dark mode */
body.dark { background:#0f1724; color:#d1d5db; }
body.dark .box, body.dark .box-welcome, body.dark .header, body.dark .footer-inner { background:#0b1220; color:#d1d5db; border-color:#223247; }
body.dark .msg .bubble { background:#07203a; color:#d1d5db; border-color:#12324a; }
.theme-toggle { position: fixed; bottom: 12px; right: 12px; z-index:999; padding:8px 10px; border-radius:8px; background:#333; color:#fff; font-size:14px; cursor:pointer; }

/* Search bar */
#searchBox { width:100%; padding:6px; margin-bottom:6px; border-radius:4px; border:1px solid #ccc; }

/* Typing indicator */
#typingIndicator { font-size:12px; color:#666; margin-bottom:6px; }

/* Leaderboard */
#leaderboard { margin-top:8px; border:1px dashed #ccc; padding:6px; border-radius:6px; background:#fff; }

/* Unread count badge */
#unreadBadge { background:#e53935; color:#fff; padding:3px 7px; border-radius:12px; margin-left:6px; font-size:12px; display:none; }

/* Profanity highlight (hidden words replaced) */
.profanity { color:#999; font-style:italic; }

/* Mention highlight */
.mention { background:#e8f0ff; padding:2px 4px; border-radius:4px; }

/* small utility */
.meta .loc { font-size:11px; color:#999; margin-left:6px; }
/* end styles */
</style>
</head>
<body>

<!-- Header -->
<div class="header-wrapper">
  <div class="header">
    <div>Welcome to Mathematics Hub</div>
    <div>Class 6 to 12</div>
  </div>
</div>

<!-- Notice Board -->
<div class="welcome-cover">
  <div class="section-title"><u>Notice Board</u> :-</div>
</div>

<div class="box-welcome">
  This website is specially designed for Students of class 6 to class 12 to clear their Maths problem in simple way ‡§Ø‡§π ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ï‡§ï‡•ç‡§∑‡§æ 6 ‡§∏‡•á ‡§ï‡§ï‡•ç‡§∑‡§æ 12 ‡§§‡§ï ‡§ï‡•á ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§∏‡§æ‡§® ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•á ‡§ó‡§£‡§ø‡§§ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§π‡§≤ ‡§ï‡§∞‡§®‡•á ‡§π‡•á‡§§‡•Å ‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§® ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à‡•§   
  <b>Notes, NCERT Solutions, Practice Tests ‡§î‡§∞ Formula Sheets</b> ‡§ï‡•á ‡§∏‡§æ‡§•‡•§
</div>

<!-- Shoutbox -->
<div class="section-title title-shout">Shoutbox <span id="unreadBadge">0</span></div>
<div class="box" id="shoutbox">
  <div id="adminStatus">‚úÖ Admin login successful</div>

  <!-- controls row: search, filter, theme -->
  <input id="searchBox" placeholder="Search messages... (type and press Enter)" />
  <div style="display:flex;gap:8px;margin-bottom:6px;">
    <input type="text" id="tagFilter" placeholder="Filter by tag e.g. #doubt" style="flex:1;padding:6px;border:1px solid #ffa500;border-radius:4px;">
    <button class="small-btn" id="clearFilters" title="Clear filters">Clear</button>
    <button class="small-btn" id="toggleTheme" title="Toggle dark/light">Theme</button>
  </div>

  <div id="typingIndicator"></div>
  <div id="messages"></div>

  <!-- message inputs -->
  <input type="text" id="username" placeholder="Name (type 'admin' to login as admin)">
  <input type="text" id="message" placeholder="Type your message (you can use $...$ for LaTeX)">
  <div style="display:flex;gap:8px;margin-bottom:6px;">
    <input type="file" id="photoInput" accept="image/*,video/*,audio/*">
    <select id="emojiPicker" title="Emoji">
      <option value="">üôÇ</option>
      <option value="üòä">üòä</option>
      <option value="üòÇ">üòÇ</option>
      <option value="üëç">üëç</option>
      <option value="‚ù§Ô∏è">‚ù§Ô∏è</option>
      <option value="üéØ">üéØ</option>
      <option value="üìå">üìå</option>
      <option value="ü§î">ü§î</option>
      <option value="üìê">üìê</option>
    </select>
    <button id="translateBtn" class="small-btn">Translate</button>
  </div>

  <div id="uploadProgress"><div id="uploadBar"></div></div>

  <div class="send-wrapper">
    <button id="sendBtn">Send</button>
    <button id="copyAllBtn" class="small-btn" title="Copy all messages">Copy All</button>
    <button id="soundToggle" class="small-btn" title="Toggle sound">üîî</button>
    <button id="leaderboardBtn" class="small-btn" title="Show Leaderboard">üèÜ</button>
  </div>

  <div class="send-wrapper">
    <button id="clearBtn">Clear Shoutbox</button>
    <button id="deleteSelectedBtn">Delete Selected</button>
    <button id="logoutBtn">Admin Logout</button>
    <button id="setSlowModeBtn" class="small-btn" style="display:none;">Set Slow Mode</button>
    <button id="pinBtn" class="small-btn" style="display:none;">Pin Message</button>
  </div>

  <div id="leaderboard" style="display:none;"></div>
  <div id="botSuggestions" style="margin-top:8px;color:#444;font-size:13px;"></div>
</div>

<!-- Updates -->
<div class="section-title title-updates" id="updates">Latest Updates</div>
<div class="box">
  ‚Ä¢ <b>Formula Sheet (6‚Äì12)</b> ‚Äî Download PDF (Updated Aug 2025)<br>
  ‚Ä¢ <b>Sample Paper 2024‚Äì25</b> ‚Äî Solutions added<br>
  ‚Ä¢ <b>Weekly Test</b> ‚Äî Integrals (Sun, 8 PM)
</div>

<!-- Classes -->
<div class="section-title title-class">Select Your Class</div>
<div class="box class-grid">
  <button class="btn btn6" onclick="location.href='class6.html'">Class 6</button>
  <button class="btn btn7" onclick="location.href='class7.html'">Class 7</button>
  <button class="btn btn8" onclick="location.href='class8.html'">Class 8</button>
  <button class="btn btn9" onclick="location.href='class9.html'">Class 9</button>
  <button class="btn btn10" onclick="location.href='class10.html'">Class 10</button>
  <button class="btn btn11" onclick="location.href='class11.html'">Class 11</button>
  <button class="btn btn12" onclick="location.href='class12.html'" style="grid-column: span 2;">Class 12</button>
</div>

<!-- Practice Zone -->
<div class="section-title title-practice" id="practice">Practice Zone</div>
<div class="box">
  Daily practice problems, MCQ quizzes ‡§î‡§∞ chapter-wise question banks.<br><br>
  <button class="btn btn-mcq12">MCQ: Class 12</button>
  <button class="btn btn9">MCQ: Class 10</button>
  <button class="btn btn7">Daily Practice</button>
</div>

<!-- Resources -->
<div class="section-title title-res" id="resources">Resources</div>
<div class="box">
  <b>Quick Links:</b><br>
  ‚Ä¢ NCERT Solutions (All Classes)<br>
  ‚Ä¢ Formula Sheets<br>
  ‚Ä¢ Sample Papers
</div>

<!-- Contact -->
<div class="section-title title-contact">Contact & Support</div>
<div class="box" id="contact-buttons">
  Email: dalbir46@gmail.com ‚Ä¢ WhatsApp: +91 9468067047<br><br>
  <button id="whatsapp-btn" onclick="window.open('https://chat.whatsapp.com/I3kosBY1yVp2irNXhkPDZV?mode=ems_share_t','_blank')"><i class="fab fa-whatsapp"></i> Join us on WhatsApp</button>
  <button id="telegram-btn" onclick="window.open('https://t.me/Mathematic_hub','_blank')"><i class="fab fa-telegram-plane"></i> Join us on Telegram</button>
</div>

<!-- Navigation Bar -->
<div class="linkbar">
  <a href="#">Home</a> | <a href="#updates">Latest Updates</a> | <a href="#practice">Practice Zone</a> | <a href="#resources">Resources</a>
</div>

<!-- Footer -->
<div class="footer-wrapper">
  <div class="footer-inner">
    ¬© 2025 Mathematics Hub
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ----------------- CONFIG & INIT ----------------- */
var firebaseConfig = {
  apiKey: "AIzaSyCrAjPSSQ5-nvEQNK1vxxZcWEi0ml4AePQ",
  authDomain: "mathematics-hub-7087f.firebaseapp.com",
  databaseURL: "https://mathematics-hub-7087f-default-rtdb.firebaseio.com",
  projectId: "mathematics-hub-7087f",
  storageBucket: "mathematics-hub-7087f.appspot.com",
  messagingSenderId: "182359137920",
  appId: "1:182359137920:web:1cf89e1d441ea1503a9065"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.database();

/* Constants */
const ADMIN_PASSWORD="Dalbir@551";
const IMGBB_API_KEY="9a1627658ec3732fd03cb87cbff0ed66";

/* State */
let slowModeSeconds = 0; // admin adjustable
let lastSentAt = {};
let blockedNames = JSON.parse(localStorage.getItem("blockedNames")||"[]");
let unreadCount = 0;
let soundEnabled = true;
let currentUserName = localStorage.getItem("lastName") || "";
document.getElementById("username").value = currentUserName;

/* simple profanity list (expand as needed) */
const profanityList = ["badword1","badword2","arse"];

/* allowed chars for safe math-eval */
const MATH_ALLOWED = /^[0-9+\-*/().\s%^]*$/;

/* Utility functions */
function escapeHtml(str){ if(str===undefined || str===null) return ""; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
function isAdminAuthenticated(){ return sessionStorage.getItem("isAdmin")==="true"; }
function setAdminAuthenticated(flag){ if(flag) sessionStorage.setItem("isAdmin","true"); else sessionStorage.removeItem("isAdmin"); updateAdminUI(); }
function updateAdminUI(){
  document.getElementById("adminStatus").style.display=isAdminAuthenticated()?"block":"none";
  document.getElementById("logoutBtn").style.display=isAdminAuthenticated()?"inline-block":"none";
  document.getElementById("deleteSelectedBtn").style.display=isAdminAuthenticated()?"inline-block":"none";
  document.getElementById("setSlowModeBtn").style.display=isAdminAuthenticated()?"inline-block":"none";
  document.getElementById("pinBtn").style.display=isAdminAuthenticated()?"inline-block":"none";
  updateCheckboxes();
}

/* timestamp formatting */
function formatDateTime(ts){
  const d = new Date(ts);
  const diff = Date.now()-ts;
  if(diff < 60000) return "just now";
  if(diff < 3600000) return Math.floor(diff/60000)+" min ago";
  if(diff < 86400000) return Math.floor(diff/3600000)+" hr ago";
  let day=d.getDate().toString().padStart(2,'0'), month=(d.getMonth()+1).toString().padStart(2,'0'), year=d.getFullYear();
  let hrs=d.getHours(), mins=d.getMinutes().toString().padStart(2,'0'), ampm=hrs>=12?'PM':'AM';
  hrs=hrs%12||12;
  return `${day}/${month}/${year} ${hrs}:${mins} ${ampm}`;
}

/* profanity filter */
function filterProfanity(text){
  let out = text;
  profanityList.forEach(w => {
    const re = new RegExp('\\b'+w+'\\b','ig');
    out = out.replace(re, match => '<span class="profanity">***</span>');
  });
  return out;
}

/* markdown -> use marked.js, but sanitize a bit */
function renderMarkdown(text){
  if(!text) return "";
  let md = marked.parse(text);
  // minimal sanitization: allow <a>, <strong>, <em>, <code>, <pre>, <p>, <br>, <ul>, <ol>, <li>, <img>
  // marked already returns safe HTML for our purposes; we still escape user inputs earlier.
  return md;
}

/* linkify: convert https/http/www to clickable links and open new tab */
function linkify(text){
  if(!text) return "";
  // add http if starts with www.
  text = text.replace(/\bwww\.[^\s]+/gi, (m)=>"http://"+m);
  // wrap urls with anchors
  return text.replace(/(https?:\/\/[^\s<]+)/gi, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color:#3366CC;">$1</a>');
}

/* safe math eval for solver */
function safeEvalMath(expr){
  expr = expr.replace(/\^/g,'**');
  if(!MATH_ALLOWED.test(expr)) return null;
  try{
    // eslint-disable-next-line no-eval
    let val = eval(expr);
    if(typeof val === "number" && isFinite(val)) return val;
  }catch(e){ return null; }
  return null;
}

/* play sound */
const ping = new Audio();
ping.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=";
function playPing(){ if(soundEnabled) ping.play().catch(()=>{}); }

/* imgbb upload */
async function uploadToImgbb(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onloadend = ()=>{
      const base64 = reader.result.split(",")[1];
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "https://api.imgbb.com/1/upload?key="+IMGBB_API_KEY);
      xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
      xhr.upload.onprogress = function(e){ if(e.lengthComputable){ const percent=(e.loaded/e.total)*100; document.getElementById("uploadProgress").style.display="block"; document.getElementById("uploadBar").style.width=percent+"%"; } };
      xhr.onload = function(){ document.getElementById("uploadProgress").style.display="none"; document.getElementById("uploadBar").style.width="0%"; if(xhr.status===200){ resolve(JSON.parse(xhr.responseText).data.url); } else reject("Upload failed"); };
      xhr.onerror = ()=>reject("Upload error");
      xhr.send("image="+encodeURIComponent(base64));
    };
    reader.readAsDataURL(file);
  });
}

/* ---------- MESSAGE RENDERING & INTERACTION ---------- */
async function addMessageToDOM(key,data){
  if(blockedNames.includes(data.name)) return;

  const div = document.createElement("div");
  div.classList.add("msg");
  if(data.pinned) div.classList.add("pinned");
  if(data.admin) div.classList.add("highlight-admin");
  div.setAttribute("data-key",key);

  // avatar
  const avatar = document.createElement("div");
  avatar.className = "avatar";
  avatar.textContent = (data.name||"G").charAt(0).toUpperCase();
  avatar.style.background = stringToColor(data.name||"Guest");
  div.appendChild(avatar);

  // bubble
  const bubble = document.createElement("div");
  bubble.className = "bubble user-bubble";

  // checkbox for admin
  let checkboxHtml="";
  if(isAdminAuthenticated()){
    checkboxHtml=`<input type="checkbox" class="msgCheck" data-key="${key}"> `;
  }

  // username with admin badge
  const unameSpan = `<span class="username ${data.admin?"admin":""}">${escapeHtml(data.name||"Guest")}${data.admin?" ‚úÖ":""}</span>`;

  // markdown + profanity + linkify + mentions highlight
  let bodyTextRaw = data.message || "";
  let filtered = filterProfanity(bodyTextRaw);
  let md = renderMarkdown(filtered);
  md = linkify(md); // ensure links clickable
  md = md.replace(/@([A-Za-z0-9_-]+)/g, '<span class="mention">@$1</span>');

  // reply info
  let replyHtml = "";
  if(data.replyToName){
    replyHtml = `<div style="font-size:13px;color:#666;margin-bottom:6px;">Reply to <strong>${escapeHtml(data.replyToName)}</strong>: ${escapeHtml(truncate(data.replyToText||"",80))}</div>`;
  }

  // media
  let mediaHtml = "";
  if(data.photoURL){
    if(/\.(mp4|webm|ogg)(\?|$)/i.test(data.photoURL)){
      mediaHtml = `<div style="margin-top:6px;"><video controls style="max-width:220px;border-radius:6px;"><source src="${data.photoURL}"></video></div>`;
    } else if(/\.(mp3|wav|m4a|ogg)(\?|$)/i.test(data.photoURL)){
      mediaHtml = `<div style="margin-top:6px;"><audio controls src="${data.photoURL}"></audio></div>`;
    } else {
      mediaHtml = `<div style="margin-top:6px;"><img src="${data.photoURL}" style="max-width:220px;border-radius:6px;"></div>`;
    }
  }

  // reactions summary
  const likes = data.likes || 0;
  const reactions = data.reactions || {};
  let reactionsHtml = `<div class="reactions">`;
  for(const r in reactions){
    reactionsHtml += `<span class="reaction" data-key="${key}" data-reaction="${r}">${escapeHtml(r)} ${reactions[r]}</span>`;
  }
  reactionsHtml += `</div>`;

  const meta = `<div class="meta">${formatDateTime(data.time)} ${data.location?("<span class='loc'>"+escapeHtml(data.location)+"</span>"):""}` +
               `${(data.seenBy && data.seenBy.admin) ? " ‚Ä¢ Seen by admin" : ""}</div>`;

  bubble.innerHTML = `${checkboxHtml}${unameSpan} ${replyHtml}<div class="msg-content">${md}</div>${mediaHtml}${reactionsHtml}${meta}`;

  // controls
  const ctrl = document.createElement("div");
  ctrl.className = "controls";

  const likeBtn = document.createElement("button");
  likeBtn.className = "small-btn";
  likeBtn.innerHTML = `‚ù§Ô∏è <span class="like-count">${likes}</span>`;
  likeBtn.title = "Like";
  likeBtn.onclick = ()=> { likeMessage(key); };

  const reactBtn = document.createElement("button");
  reactBtn.className = "small-btn";
  reactBtn.innerHTML = "üôÇ";
  reactBtn.title = "React";
  reactBtn.onclick = ()=> { showReactPrompt(key); };

  const copyBtn = document.createElement("button");
  copyBtn.className = "small-btn";
  copyBtn.innerHTML = "üìã";
  copyBtn.title = "Copy message";
  copyBtn.onclick = ()=> {
    navigator.clipboard.writeText(data.message || "").then(()=>{ alert("Copied"); });
  };

  const replyBtn = document.createElement("button");
  replyBtn.className = "small-btn";
  replyBtn.innerHTML = "‚Ü©";
  replyBtn.title = "Reply";
  replyBtn.onclick = ()=> {
    document.getElementById("message").value = `@${data.name} `;
    document.getElementById("message").focus();
    document.getElementById("message").dataset.replyToKey = key;
    document.getElementById("message").dataset.replyToName = data.name;
    document.getElementById("message").dataset.replyToText = data.message;
  };

  const delBtn = document.createElement("button");
  delBtn.className = "small-btn";
  delBtn.innerHTML = "üóë";
  delBtn.title = "Delete (if your message)";
  delBtn.onclick = ()=> {
    const myName = (document.getElementById("username").value||"").trim();
    if(myName && myName === data.name){
      if(confirm("Delete your message?")) { db.ref("shoutbox/"+key).remove(); const el = document.querySelector(".msg[data-key='"+key+"']"); if(el) el.remove(); }
    } else alert("You can only delete your own messages (same name).");
  };

  const reportBtn = document.createElement("button");
  reportBtn.className = "small-btn";
  reportBtn.innerHTML = "‚ö†";
  reportBtn.title = "Report message";
  reportBtn.onclick = ()=> {
    if(confirm("Report this message to admin?")){
      db.ref("reports").push({ key, reportedAt: Date.now(), by: document.getElementById("username").value||"Guest", message: data.message||"" });
      alert("Reported. Admin will review.");
    }
  };

  const blockBtn = document.createElement("button");
  blockBtn.className = "small-btn";
  blockBtn.innerHTML = "üö´";
  blockBtn.title = "Block user locally";
  blockBtn.onclick = ()=> {
    if(confirm("Block "+data.name+" locally?")){
      blockedNames.push(data.name);
      localStorage.setItem("blockedNames", JSON.stringify(blockedNames));
      document.querySelectorAll(".msg").forEach(m=>{ if(m.querySelector(".username") && m.querySelector(".username").textContent.trim().startsWith(data.name)) m.remove(); });
    }
  };

  const pinBtn = document.createElement("button");
  pinBtn.className = "small-btn";
  pinBtn.innerHTML = "üìå";
  pinBtn.title = "Pin (admin)";
  pinBtn.style.display = isAdminAuthenticated()?"inline-block":"none";
  pinBtn.onclick = async ()=> {
    if(!isAdminAuthenticated()) return alert("Admin only");
    const cur = !!data.pinned;
    await db.ref("shoutbox/"+key).update({ pinned: !cur });
  };

  ctrl.appendChild(likeBtn);
  ctrl.appendChild(reactBtn);
  ctrl.appendChild(copyBtn);
  ctrl.appendChild(replyBtn);
  ctrl.appendChild(delBtn);
  ctrl.appendChild(reportBtn);
  ctrl.appendChild(blockBtn);
  ctrl.appendChild(pinBtn);

  bubble.appendChild(ctrl);
  div.appendChild(bubble);

  document.getElementById("messages").prepend(div);

  // render math (MathJax)
  if(window.MathJax) MathJax.typesetPromise && MathJax.typesetPromise();

  // unread & notifications
  if(document.hidden){ unreadCount++; showUnreadBadge(); if(soundEnabled) playPing(); showBrowserNotification(data); }
  else { playPing(); }

  // attach reaction click handlers (delegated)
  div.querySelectorAll(".reaction").forEach(rEl=>{
    rEl.onclick = ()=> {
      const react = rEl.getAttribute("data-reaction");
      db.ref("shoutbox/"+key+"/reactions/"+react).transaction(curr => (curr||0)+1);
    };
  });
}

/* helper functions */
function truncate(s,n){ if(!s) return ""; return s.length>n?s.slice(0,n)+"...":s; }
function stringToColor(str){
  let hash=0; for(let i=0;i<str.length;i++) hash = str.charCodeAt(i) + ((hash<<5)-hash);
  const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
  return "#"+("00000".substring(0,6-c.length)+c);
}
function updateCheckboxes(){
  document.querySelectorAll(".msg").forEach(msg=>{
    let chk=msg.querySelector(".msgCheck");
    if(isAdminAuthenticated()){
      if(!chk){ const key=msg.getAttribute("data-key"); const input=document.createElement("input"); input.type="checkbox"; input.className="msgCheck"; input.setAttribute("data-key",key); msg.querySelector(".bubble").prepend(input); }
    } else{ if(chk) chk.remove(); }
  });
}
function showUnreadBadge(){
  const b = document.getElementById("unreadBadge");
  if(unreadCount>0){ b.style.display="inline-block"; b.textContent = unreadCount; }
  else b.style.display="none";
}
function showBrowserNotification(data){
  if(!("Notification" in window)) return;
  if(Notification.permission === "default") Notification.requestPermission();
  if(Notification.permission === "granted"){
    const title = (data.name||"User") + ": " + ((data.message||"").slice(0,120));
    const n = new Notification("Mathematics Hub ‚Äî New message", { body: title, icon: null });
    setTimeout(()=>n.close(),4000);
  }
}
function showReactPrompt(key){
  const opts = ["üëç","üòÇ","‚ù§Ô∏è","ü§î"];
  const r = prompt("React with one of: "+opts.join(" "), opts[0]);
  if(!r) return;
  db.ref("shoutbox/"+key+"/reactions/"+r).transaction(curr => (curr||0)+1);
}
function likeMessage(key){
  db.ref("shoutbox/"+key+"/likes").transaction(curr => (curr||0)+1);
}

/* copy all messages */
document.getElementById("copyAllBtn").addEventListener("click", ()=>{
  const texts = Array.from(document.querySelectorAll(".msg .msg-content")).map(n=>n.innerText).join("\n\n");
  navigator.clipboard.writeText(texts).then(()=>alert("All messages copied"));
});

/* typing indicator */
let typingTimeout;
document.getElementById("message").addEventListener("input", ()=>{
  const name = (document.getElementById("username").value||"Guest").trim();
  if(!name) return;
  db.ref("typing/"+name).set(true);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{ db.ref("typing/"+name).remove(); },2000);
});
db.ref("typing").on("value", snap=>{
  const val = snap.val() || {};
  const keys = Object.keys(val);
  const current = (document.getElementById("username").value||"").trim();
  const others = keys.filter(k=>k!==current);
  document.getElementById("typingIndicator").textContent = others.length ? (others.join(", ") + " typing...") : "";
});

/* leaderboard points */
function updateLeaderboardUI(){
  db.ref("users").orderByChild("points").limitToLast(10).once("value").then(s=>{
    const html = [];
    s.forEach(child=> html.push(`${escapeHtml(child.key)} ‚Äî ${child.val().points} pts`));
    document.getElementById("leaderboard").innerHTML = "<strong>Leaderboard</strong><br>"+html.reverse().join("<br>");
  });
}
document.getElementById("leaderboardBtn").addEventListener("click", ()=>{
  const lb = document.getElementById("leaderboard");
  if(lb.style.display === "none" || !lb.style.display) { updateLeaderboardUI(); lb.style.display = "block"; }
  else lb.style.display = "none";
});

/* tag filter */
document.getElementById("tagFilter").addEventListener("input", ()=>{
  const tag = document.getElementById("tagFilter").value.trim().toLowerCase();
  if(!tag) { document.querySelectorAll(".msg").forEach(m=>m.style.display="flex"); return; }
  document.querySelectorAll(".msg").forEach(m=>{
    const content = m.querySelector(".msg-content").innerText.toLowerCase();
    m.style.display = content.includes(tag.replace("#","").toLowerCase()) ? "flex" : "none";
  });
});
document.getElementById("clearFilters").addEventListener("click", ()=>{ document.getElementById("tagFilter").value=""; document.getElementById("searchBox").value=""; document.querySelectorAll(".msg").forEach(m=>m.style.display="flex"); });

/* search (Enter) */
document.getElementById("searchBox").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ const q=document.getElementById("searchBox").value.toLowerCase(); document.querySelectorAll(".msg").forEach(m=>{ const t = m.innerText.toLowerCase(); m.style.display = t.includes(q) ? "flex" : "none"; }); }});

/* theme toggle (make visible & styled) */
document.getElementById("toggleTheme").addEventListener("click", ()=>{
  document.body.classList.toggle("dark");
  // small visual feedback
  document.getElementById("toggleTheme").textContent = document.body.classList.contains("dark") ? "Theme: Dark" : "Theme: Light";
});
/* ensure toggle looks good initially */
document.getElementById("toggleTheme").style.padding = "6px 10px";
document.getElementById("toggleTheme").style.border = "1px solid #ccc";
document.getElementById("toggleTheme").style.borderRadius = "6px";

/* sound toggle */
document.getElementById("soundToggle").addEventListener("click", ()=>{
  soundEnabled = !soundEnabled;
  document.getElementById("soundToggle").textContent = soundEnabled ? "üîî" : "üîï";
});

/* translate: open google translate */
document.getElementById("translateBtn").addEventListener("click", ()=>{
  const text = document.getElementById("message").value;
  if(!text) return alert("Type message to translate.");
  const url = "https://translate.google.com/?sl=auto&tl=en&text="+encodeURIComponent(text);
  window.open(url,"_blank");
});

/* emoji picker */
document.getElementById("emojiPicker").addEventListener("change", (e)=>{
  if(e.target.value){ document.getElementById("message").value += " " + e.target.value; e.target.value = ""; document.getElementById("message").focus(); }
});

/* set slow mode (admin) */
document.getElementById("setSlowModeBtn").addEventListener("click", ()=>{
  const s = parseInt(prompt("Enter slow mode seconds (0 to disable):", slowModeSeconds||0));
  if(!isNaN(s)){ slowModeSeconds = s; db.ref("meta/slowMode").set(s); alert("Slow mode set to "+s+" seconds"); }
});

/* pin button action (admin) */
document.getElementById("pinBtn").addEventListener("click", async ()=>{
  const sel = document.querySelector(".msg .msgCheck:checked");
  if(!sel) return alert("Select message checkbox to pin.");
  const key = sel.getAttribute("data-key");
  const snap = await db.ref("shoutbox/"+key).once("value");
  const cur = snap.val() || {};
  await db.ref("shoutbox/"+key).update({ pinned: !cur.pinned });
});

/* clear & delete selected */
document.getElementById("clearBtn").addEventListener("click", ()=>{ if(isAdminAuthenticated() && confirm("Clear all messages?")){ db.ref("shoutbox").remove(); document.getElementById("messages").innerHTML=""; } else { alert("Admin only"); } });
document.getElementById("deleteSelectedBtn").addEventListener("click", ()=>{ if(isAdminAuthenticated()){ document.querySelectorAll(".msgCheck:checked").forEach(chk=>{ const key=chk.getAttribute("data-key"); db.ref("shoutbox/"+key).remove(); const el = document.querySelector(".msg[data-key='"+key+"']"); if(el) el.remove(); }); } else alert("Admin only"); });
document.getElementById("logoutBtn").addEventListener("click", ()=>{ setAdminAuthenticated(false); });

/* update admin UI initially */
updateAdminUI();

/* ---------- SENDING MESSAGES (with spam & slow mode & points) ---------- */
document.getElementById("sendBtn").addEventListener("click", async ()=>{
  const nameEl=document.getElementById("username"); const msgEl=document.getElementById("message"); const photoEl=document.getElementById("photoInput");
  const name = (nameEl.value||"").trim();
  const msg = (msgEl.value||"").trim();

  if(!name && !photoEl.files[0] && !msg) return alert("Enter message or photo.");
  // admin login
  if(name.toLowerCase()==="admin" && !isAdminAuthenticated()){
    const pwd = prompt("Enter admin password:");
    if(pwd===ADMIN_PASSWORD){ setAdminAuthenticated(true); markAllSeenByAdmin(); } else { alert("Incorrect password."); return; }
  }

  // slow mode from DB
  const metaSnap = await db.ref("meta/slowMode").once("value");
  const slow = metaSnap.exists() ? (metaSnap.val()||0) : slowModeSeconds;
  const now = Date.now();
  if(slow>0){
    const last = lastSentAt[name] || 0;
    if(now - last < slow*1000 && !(isAdminAuthenticated() && name.toLowerCase()==="admin")) return alert("Slow mode: wait "+Math.ceil((slow*1000 - (now-last))/1000)+" sec");
  }

  // local spam control: avoid same msg rapid send
  const lastMsgKey = "lastMsg_"+name;
  const lastMsgObj = JSON.parse(localStorage.getItem(lastMsgKey) || "{}");
  if(lastMsgObj.text === msg && (Date.now() - lastMsgObj.time < 5000)) return alert("Please don't spam same message.");

  // upload
  let photoURL = "";
  if(photoEl.files && photoEl.files[0]){
    const f = photoEl.files[0];
    if(f.size > 8*1024*1024) return alert("File too large (max 8MB).");
    try{ photoURL = await uploadToImgbb(f); photoEl.value = ""; } catch(e){ alert("Upload failed: "+e); return; }
  }

  // reply info
  const replyToKey = msgEl.dataset.replyToKey || null;
  const replyToName = msgEl.dataset.replyToName || null;
  const replyToText = msgEl.dataset.replyToText || null;
  delete msgEl.dataset.replyToKey; delete msgEl.dataset.replyToName; delete msgEl.dataset.replyToText;

  // compose data
  const data = {
    name: name || "Guest",
    message: msg || "",
    time: Date.now(),
    photoURL: photoURL || "",
    location: "",
    admin: (isAdminAuthenticated() && name.toLowerCase()==="admin")||false,
    likes: 0,
    reactions: {},
    pinned: false,
    replyToKey, replyToName, replyToText,
    seenBy: {}
  };

  // increment points
  db.ref("users/"+(data.name||"Guest")).transaction(curr=> {
    if(curr && curr.points) { curr.points = curr.points + 1; return curr; }
    return { points: 1 };
  });

  // push
  db.ref("shoutbox").push(data);
  msgEl.value = "";
  lastSentAt[name] = Date.now();
  localStorage.setItem(lastMsgKey, JSON.stringify({ text: msg, time: Date.now() }));

  // bot responses / suggestions
  autoBotResponses(data);

  // save last name
  localStorage.setItem("lastName", name);
});

/* ---------- BOT / MATH ASSISTANT / SUGGESTIONS ---------- */
function autoBotResponses(userMsg){
  const txt = (userMsg.message||"").toLowerCase();
  const suggestionsEl = document.getElementById("botSuggestions");
  suggestionsEl.textContent = "";

  // welcome for new user (first message)
  db.ref("users/"+userMsg.name).once("value").then(s=>{
    if(!s.exists() || (s.val() && s.val().points <= 1)){
      db.ref("shoutbox").push({ name: "MathBot", message: "Welcome "+userMsg.name+" üëã ‚Äî Ask your math doubts! Type `solve 2+2` or use `$...$` for equations.", time: Date.now(), admin:false });
    }
  });

  // math solver
  if(txt.startsWith("solve ")){
    const expr = userMsg.message.slice(6).trim();
    const safe = expr.replace(/[^0-9+\-*/().\s%^]/g,"");
    const res = safeEvalMath(safe);
    const reply = res === null ? "Sorry, I couldn't evaluate that expression." : "Result: " + res;
    db.ref("shoutbox").push({ name: "MathBot", message: reply, time: Date.now() });
    return;
  }

  // smart suggestions on keywords
  if(/formula|integral|derivative|limit|matrix|solve|question|proof/.test(txt)){
    suggestionsEl.innerHTML = "Tip: Use `$...$` for LaTeX (example: `$\\int x^2 dx$`). Try `solve 45/5`.";
  }

  // greetings
  if(/hello|hi|hey/.test(txt)){
    db.ref("shoutbox").push({ name: "MathBot", message: "Hi "+userMsg.name+"! Need help with any chapter?", time: Date.now() });
  }
}

/* ---------- LISTENERS: DB -> DOM ---------- */
db.ref("shoutbox").orderByChild("time").limitToLast(200).on("child_added", snap=>{ addMessageToDOM(snap.key, snap.val()); });
db.ref("shoutbox").on("child_changed", snap=>{
  const key = snap.key; const data = snap.val();
  const el = document.querySelector(".msg[data-key='"+key+"']");
  if(el) el.remove();
  addMessageToDOM(key,data);
  updateLeaderboardUI();
});
db.ref("shoutbox").on("child_removed", snap=>{
  const el = document.querySelector(".msg[data-key='"+snap.key+"']");
  if(el) el.remove();
});

/* mark all messages as seen by admin when admin logs in (read receipts) */
async function markAllSeenByAdmin(){
  if(!isAdminAuthenticated()) return;
  const snap = await db.ref("shoutbox").once("value");
  const all = snap.val() || {};
  Object.keys(all).forEach(k => {
    db.ref("shoutbox/"+k+"/seenBy/admin").set(Date.now());
  });
}

/* fetch typing/presence handled above in typing listeners */

/* adminStatus click to show IP (optional) */
document.getElementById("adminStatus").addEventListener("click", async ()=>{
  if(!isAdminAuthenticated()) return;
  try{
    const res = await fetch('https://ipapi.co/json/');
    const info = await res.json();
    alert("IP: "+info.ip+"\nCity: "+info.city+", "+info.region+"\nCountry: "+info.country_name);
  }catch(e){ alert("Could not fetch IP info"); }
});

/* visibility change reset unread */
document.addEventListener("visibilitychange", ()=>{ if(!document.hidden){ unreadCount = 0; showUnreadBadge(); } });

/* request notification permission on load */
if("Notification" in window && Notification.permission === "default") Notification.requestPermission();

/* initial setup */
updateLeaderboardUI();
showUnreadBadge();

/* End of script */
</script>
</body>
</html>
